<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>AI Story Tailor v7.9.5</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    body{font-family:'Sarabun',sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px 0}
    .main-card{border-radius:20px;border:none;box-shadow:0 20px 60px rgba(0,0,0,0.3);background:#fff;overflow:hidden}
    .card-header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:30px;text-align:center}
    .api-management{background:#f1f3f5;padding:10px 20px;border-bottom:1px solid #eee;display:flex;justify-content:center;align-items:center}
    .story-display{line-height:2.4;font-size:1.25rem;color:#333;padding:30px;background:#fff;border-radius:15px;margin-top:20px}
    .word-clickable{cursor:pointer;border-bottom:2px dotted #667eea;transition:all 0.2s;padding:2px 0}
    .word-clickable:hover{background-color:rgba(102,126,234,0.15);color:#667eea;border-radius:4px}
    .tooltip-box{position:absolute;background:#1e293b;color:#fff;padding:12px 18px;border-radius:10px;display:none;pointer-events:none;z-index:10000;box-shadow:0 10px 25px rgba(0,0,0,0.3);max-width:250px}
    .btn-generate{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);border:none;color:#fff;font-weight:600;padding:15px;border-radius:12px;transition:all 0.2s}
    .btn-generate:hover:not(:disabled){transform:translateY(-2px);box-shadow:0 5px 15px rgba(102,126,234,0.4);color:#fff}
    .btn-generate:disabled{opacity:0.7}
    #loading{display:none}
    .status-badge{font-size:0.75rem;padding:4px 12px;border-radius:20px;background:#d4edda;color:#155724}
    .status-badge.error{background:#f8d7da;color:#721c24}
    .speaking{animation:pulse 0.5s ease-in-out}
    @keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1);background-color:rgba(102,126,234,0.3)}}
  </style>
</head>
<body>
<div class="container">
  <div class="row justify-content-center">
    <div class="col-lg-10">
      <div class="card main-card">
        <div class="card-header">
          <h2>‚ú® AI Story Tailor v7.9.5</h2>
          <p class="mb-0 opacity-75">Secure Edition - ‡∏£‡∏∞‡∏ö‡∏ö‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡πÑ‡∏°‡πà‡∏´‡∏•‡∏∏‡∏î API Key</p>
        </div>
        <div class="api-management">
          <span id="statusBadge" class="status-badge">‚óè ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...</span>
        </div>
        <div class="card-body p-4">
          <div class="mb-4">
            <label class="form-label fw-bold">üìù ‡πÉ‡∏™‡πà‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏≤‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ:</label>
            <input type="text" id="topic" class="form-control form-control-lg shadow-sm" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏õ‡πà‡∏≤, ‡∏Å‡∏≤‡∏£‡πÑ‡∏õ‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß‡∏ó‡∏∞‡πÄ‡∏•, ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß...">
          </div>
          <button onclick="generate()" id="genBtn" class="btn btn-generate w-100 shadow">üöÄ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏ó‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©</button>
          <div id="loading" class="text-center my-5">
            <div class="spinner-border text-primary" style="width:3.5rem;height:3.5rem"></div>
            <p class="mt-3 fw-bold text-secondary">AI ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß...</p>
          </div>
          <div id="errorMsg" class="alert alert-danger mt-3" style="display:none;"></div>
          <div id="storyOut" class="story-display mt-4 shadow-sm" style="display:none;"></div>
          <div class="mt-4 p-3 bg-light rounded">
            <h6 class="text-muted">üí° ‡∏ß‡∏¥‡∏ò‡∏µ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:</h6>
            <ul class="text-muted small mb-0">
              <li><strong>‡∏ä‡∏µ‡πâ‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå</strong> - ‡∏î‡∏π‡∏Ñ‡∏≥‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</li>
              <li><strong>‡∏Ñ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏®‡∏±‡∏û‡∏ó‡πå</strong> - ‡∏ü‡∏±‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏≠‡∏Å‡πÄ‡∏™‡∏µ‡∏¢‡∏á</li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
<div id="tbox" class="tooltip-box"></div>
<script>
// ‡∏ù‡∏±‡∏á URL ‡πÑ‡∏ß‡πâ‡πÄ‡∏•‡∏¢ - ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
const API_URL = 'https://script.google.com/macros/s/AKfycbx7sJXcgwZi_jo-vkPqGrObxW8iXXr4wm5aGxKIUPc9YFMYumrkQ9EI_zYmdLv6-ae0TA/exec';

document.addEventListener('DOMContentLoaded',()=>{
  checkApiStatus();
  document.getElementById('topic').addEventListener('keypress',e=>{if(e.key==='Enter')generate()});
});

async function checkApiStatus(){
  const badge=document.getElementById('statusBadge');
  badge.textContent='‚óè ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö...';
  try{
    const res=await fetch(API_URL);
    const data=await res.json();
    if(data.status==='ok'){
      badge.textContent='‚óè ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô';
      badge.className='status-badge';
    }else throw new Error();
  }catch(e){
    badge.textContent='‚ö†Ô∏è ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ';
    badge.className='status-badge error';
  }
}

async function generate(){
  const topic=document.getElementById('topic').value.trim();
  if(!topic){alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏∞‡∏ö‡∏∏‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á');return}
  const btn=document.getElementById('genBtn');
  const load=document.getElementById('loading');
  const out=document.getElementById('storyOut');
  const errMsg=document.getElementById('errorMsg');
  btn.disabled=true;
  load.style.display='block';
  out.style.display='none';
  errMsg.style.display='none';
  try{
    const res=await fetch(API_URL+'?topic='+encodeURIComponent(topic));
    const data=await res.json();
    if(data.error)throw new Error(data.error);
    if(!data.story)throw new Error('‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏£‡∏≤‡∏ß');
    renderStory(data.story);
    out.style.display='block';
    out.scrollIntoView({behavior:'smooth'});
  }catch(err){
    errMsg.textContent='‚ùå '+err.message;
    errMsg.style.display='block';
  }finally{
    btn.disabled=false;
    load.style.display='none';
  }
}

function renderStory(txt){
  const out=document.getElementById('storyOut');
  out.innerHTML='';
  txt.split(/\n\n+/).forEach(pTxt=>{
    if(!pTxt.trim())return;
    const p=document.createElement('p');
    p.style.marginBottom='1.5rem';
    pTxt.split(/(\s+)/).forEach(token=>{
      if(/[a-zA-Z]/.test(token)){
        const span=document.createElement('span');
        span.className='word-clickable';
        span.textContent=token;
        span.onmouseover=e=>showTranslation(e,token);
        span.onmouseout=hideTooltip;
        span.onclick=()=>speakWord(token,span);
        p.appendChild(span);
      }else{
        p.appendChild(document.createTextNode(token));
      }
    });
    out.appendChild(p);
  });
}

async function showTranslation(e,word){
  const cw=word.replace(/[.,!?;:"'()]/g,'').toLowerCase();
  const tb=document.getElementById('tbox');
  tb.style.left=(window.scrollX+e.target.getBoundingClientRect().left)+'px';
  tb.style.top=(window.scrollY+e.target.getBoundingClientRect().bottom+8)+'px';
  tb.style.display='block';
  tb.innerHTML='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏õ‡∏•...';
  try{
    const r=await fetch('https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=th&dt=t&q='+encodeURIComponent(cw));
    const d=await r.json();
    tb.innerHTML='<strong>'+cw+'</strong><br><span style="color:#fbbf24">üáπüá≠ '+d[0][0][0]+'</span>';
  }catch(err){tb.innerHTML=cw}
}

function hideTooltip(){document.getElementById('tbox').style.display='none'}

function speakWord(word,el){
  const cw=word.replace(/[.,!?;:"'()]/g,'');
  el.classList.add('speaking');
  setTimeout(()=>el.classList.remove('speaking'),500);
  const ut=new SpeechSynthesisUtterance(cw);
  ut.lang='en-US';
  ut.rate=0.8;
  speechSynthesis.speak(ut);
}
</script>
</body>
</html>
